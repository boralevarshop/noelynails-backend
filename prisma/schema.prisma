// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  ADMIN_GLOBAL
  DONO_SALAO
  PROFISSIONAL
  CLIENTE
}

enum StatusAgendamento {
  PENDENTE
  CONFIRMADO
  CANCELADO
  CONCLUIDO
}

// SALÕES (TENANTS)
model Tenant {
  id               String    @id @default(uuid())
  nome             String
  slug             String    @unique
  telefone         String?
  logoUrl          String?
  corPrimaria      String    @default("#000000")
  
  plano            String    @default("FREE")
  asaasCustomerId  String?   
  statusAssinatura String    @default("ACTIVE")
  trialFim         DateTime? 
  whatsappInstance String?   
  ativo            Boolean   @default(true)

  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  usuarios         Usuario[]
  servicos         Servico[]
  agendamentos     Agendamento[]
  clientes         Cliente[]
  bloqueios        Bloqueio[]

  @@map("tenants")
}

// USUÁRIOS
model Usuario {
  id          String   @id @default(uuid())
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id])
  
  nome        String
  email       String   @unique
  senha       String
  role        Role     @default(PROFISSIONAL)
  telefone    String?
  
  // --- NOVOS CAMPOS DE PERFIL ---
  bio         String?  // Ex: "Especialista em Loiras"
  instagram   String?  // Ex: "@ana.hair"
  avatarUrl   String?  // URL da foto
  
  // Configurações
  horarios    Json?    // { "seg": { "inicio": "09:00", "fim": "18:00" }, "ter": ... }
  notificacoes Json?   // { "whatsapp": true }

  // Relacionamentos
  agendamentos      Agendamento[] 
  bloqueios         Bloqueio[]
  servicosQueAtende Servico[] @relation("ProfissionalServicos") // Quem faz o quê

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("usuarios")
}

// SERVIÇOS
model Servico {
  id          String   @id @default(uuid())
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id])
  
  nome        String
  descricao   String?
  preco       Decimal  @db.Decimal(10, 2)
  duracaoMin  Int
  diasRetorno Int      @default(30) 

  ativo       Boolean  @default(true)
  agendamentos Agendamento[]
  
  // Relação inversa: Quais profissionais fazem este serviço?
  profissionais Usuario[] @relation("ProfissionalServicos")

  @@map("servicos")
}

// CLIENTES
model Cliente {
  id          String   @id @default(uuid())
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id])
  nome        String
  telefone    String   
  email       String?
  agendamentos Agendamento[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([tenantId, telefone])
  @@map("clientes")
}

// AGENDAMENTOS
model Agendamento {
  id             String            @id @default(uuid())
  tenantId       String
  tenant         Tenant            @relation(fields: [tenantId], references: [id])
  clienteId      String
  cliente        Cliente           @relation(fields: [clienteId], references: [id])
  profissionalId String
  profissional   Usuario           @relation(fields: [profissionalId], references: [id])
  servicoId      String
  servico        Servico           @relation(fields: [servicoId], references: [id])
  
  dataHora       DateTime 
  dataFim        DateTime 
  status         StatusAgendamento @default(PENDENTE)
  observacoes    String?
  canceladoPor   String?
  lembreteEnviado Boolean          @default(false)

  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt

  @@index([tenantId, dataHora])
  @@map("agendamentos")
}

// BLOQUEIOS
model Bloqueio {
  id             String   @id @default(uuid())
  tenantId       String
  tenant         Tenant   @relation(fields: [tenantId], references: [id])
  profissionalId String
  profissional   Usuario  @relation(fields: [profissionalId], references: [id])
  inicio         DateTime
  fim            DateTime
  motivo         String? 
  createdAt      DateTime @default(now())

  @@map("bloqueios")
}